rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function getLoggedInUserId() {
      return request.auth.token.userId;
    }
    
    // Helper function to check if user has access to a tag
    function hasTagAccess(tagId) {
      let tag = get(/databases/$(database)/documents/Tags/$(tagId)).data;
      return getLoggedInUserId() == tag.ownerId || 
             getLoggedInUserId() in tag.sharedWith;
    }
    
    // Users collection - users can only read/write their own document
    match /Users/{userId} {
      allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      
      // User's Expenses subcollection
      match /Expenses/{expenseId} {
        allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      }

	  match /Friends/{friendId} {
		allow read, write: if request.auth != null && getLoggedInUserId() == userId;
	  }
    }
    
    // Tags collection
    match /Tags/{tagId} {
      // Users can read tag if they are owner or in sharedWith array
      allow read: if request.auth != null && 
        (getLoggedInUserId() == resource.data.ownerId || getLoggedInUserId() in resource.data.sharedWith);
      
      // Users can create tag if they set themselves as owner
      allow create: if request.auth != null && 
        getLoggedInUserId() == request.resource.data.ownerId;
      
      // Only owner can update/delete tag
      allow update, delete: if request.auth != null && 
        getLoggedInUserId() == resource.data.ownerId;
      
      // Tag's Expenses subcollection
      match /Expenses/{expenseId} {
        // Users can read expenses if they have access to the parent tag
        allow read: if request.auth != null && hasTagAccess(tagId);
        
        allow write: if request.auth != null && 
		  hasTagAccess(tagId) &&
          getLoggedInUserId() == request.resource.data.ownerId;
      }
    }

	match /PublicInfo/{userId} {
  		allow read: if request.auth != null;
		allow write: if request.auth != null && getLoggedInUserId() == userId;
	}
  }
}