rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function getLoggedInUserId() {
      return request.auth.token.userId;
    }
    
    // Helper function to check if user has access to a tag
    function hasTagAccess(tagId) {
      let tag = get(/databases/$(database)/documents/Tags/$(tagId)).data;
      return getLoggedInUserId() == tag.ownerId || 
             getLoggedInUserId() in tag.sharedWith;
    }
    
    // Users collection - users can only read/write their own document
    match /Users/{userId} {
      allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      
      // User's Expenses subcollection
      match /Expenses/{expenseId} {
        allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      }

      match /WIPExpenses/{expenseId} {
        allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      }

      match /Friends/{friendId} {
        allow read, write: if request.auth != null && getLoggedInUserId() == userId;
      }
    }
    
    // Tags collection
    match /Tags/{tagId} {
      // Users can read tag if they are owner or in sharedWith array
      allow read: if request.auth != null && 
        (getLoggedInUserId() == resource.data.ownerId || getLoggedInUserId() in resource.data.sharedWith);
      
      // Users can create tag if they set themselves as owner
      allow create: if request.auth != null && 
        getLoggedInUserId() == request.resource.data.ownerId;
      
      // Only owner can update/delete tag
      allow update, delete: if request.auth != null && 
        getLoggedInUserId() == resource.data.ownerId;

      // users can add themselves to Tag by clicking on the tag link
      allow update: if request.auth != null && 
                request.resource.data.diff(resource.data).affectedKeys()
                .hasOnly(['sharedWith']) &&
                request.resource.data.sharedWith.hasAll(resource.data.sharedWith);
      
      // Tag's Expenses subcollection
      match /Expenses/{expenseId} {
        // Users can read expenses if they have access to the parent tag
        allow read: if request.auth != null && hasTagAccess(tagId);
        
        allow create: if request.auth != null && 
		      hasTagAccess(tagId) &&
          getLoggedInUserId() == request.resource.data.ownerId;

		    // Only owner of expense or owner of tag can update/delete expense
      	allow update: if request.auth != null && 
          getLoggedInUserId() == resource.data.ownerId;

        allow delete: if request.auth != null && 
          ( getLoggedInUserId() == get(/databases/$(database)/documents/Tags/$(tagId)).data.ownerId ||
             getLoggedInUserId() == resource.data.ownerId ) ;
      }

      // Tag's Settlements subcollection (same rules as Expenses)
      match /Settlements/{settlementId} {
        allow read: if request.auth != null && hasTagAccess(tagId);
        
        allow create: if request.auth != null && 
          hasTagAccess(tagId) &&
          getLoggedInUserId() == request.resource.data.ownerId;

        allow update: if request.auth != null && 
          getLoggedInUserId() == resource.data.ownerId;

        allow delete: if request.auth != null && 
          ( getLoggedInUserId() == get(/databases/$(database)/documents/Tags/$(tagId)).data.ownerId ||
            getLoggedInUserId() == resource.data.ownerId ) ;
      }

    }

    match /PublicInfo/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && getLoggedInUserId() == userId;
    }
  }
}